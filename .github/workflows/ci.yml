name: CI

on:
  push:
    paths-ignore:
      - '.github/**'
      - 'README.md'
      - 'CHANGELOG.md'

  workflow_dispatch:

jobs:
  build:
    name: 打包

    runs-on: ubuntu-latest

    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

        with:
          fetch-depth: 0

      - name: 读取并更新版本号
        id: version
        run: |
          version=$(grep '^version=' ./module/module.prop | cut -d= -f2)
          versionCode=$(grep '^versionCode=' ./module/module.prop | cut -d= -f2)
          versionCode=$((versionCode + 1))
          version=$(echo "$version" | sed "s/(\([0-9]\+\))/($versionCode)/")
          echo "version=$version" >> $GITHUB_OUTPUT
          sed -i "s/^version=.*/version=$version/" ./module/module.prop
          sed -i "s/^versionCode=.*/versionCode=$versionCode/" ./module/module.prop

      - name: 推送更改至仓库
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add ./module/module.prop
          git commit -m "chore: 更新 versionCode"
          git push

      - name: 打包
        run: |
          mkdir -p ./pack
          cp -r ./module/* ./pack
          cp -r ./script ./pack
          cp ./install.sh ./pack/customize.sh
          cd ./pack
          zip -r9 "../${{ github.event.repository.name }}_${{ steps.version.outputs.version }}.zip" .
          cd ..

      - name: 上传打包结果
        uses: actions/upload-artifact@v4

        with:
          name: ${{ github.event.repository.name }}_${{ steps.version.outputs.version }}.zip

          path: ./${{ github.event.repository.name }}_${{ steps.version.outputs.version }}.zip